# Comparing `tmp/stix_shifter_modules_azure_sentinel-5.1.1-py2.py3-none-any.whl.zip` & `tmp/stix_shifter_modules_azure_sentinel-5.1.1.dev796-py2.py3-none-any.whl.zip`

## zipinfo {}

```diff
@@ -1,27 +1,27 @@
-Zip file size: 41269 bytes, number of entries: 25
--rw-rw-r--  2.0 unx        0 b- defN 23-Mar-21 13:47 stix_shifter_modules/azure_sentinel/__init__.py
--rw-rw-r--  2.0 unx      432 b- defN 23-Mar-21 13:47 stix_shifter_modules/azure_sentinel/entry_point.py
--rw-rw-r--  2.0 unx    55888 b- defN 23-Mar-21 13:51 stix_shifter_modules/azure_sentinel/configuration/config.json
--rw-rw-r--  2.0 unx       78 b- defN 23-Mar-21 13:51 stix_shifter_modules/azure_sentinel/configuration/dialects.json
--rw-rw-r--  2.0 unx     3405 b- defN 23-Mar-21 13:51 stix_shifter_modules/azure_sentinel/configuration/lang_en.json
--rw-rw-r--  2.0 unx        0 b- defN 23-Mar-21 13:47 stix_shifter_modules/azure_sentinel/stix_translation/__init__.py
--rw-rw-r--  2.0 unx    21567 b- defN 23-Mar-21 13:51 stix_shifter_modules/azure_sentinel/stix_translation/json_to_stix_translator.py
--rw-rw-r--  2.0 unx    21183 b- defN 23-Mar-21 13:47 stix_shifter_modules/azure_sentinel/stix_translation/query_constructor.py
--rw-rw-r--  2.0 unx     1037 b- defN 23-Mar-21 13:47 stix_shifter_modules/azure_sentinel/stix_translation/query_translator.py
--rw-rw-r--  2.0 unx      133 b- defN 23-Mar-21 13:47 stix_shifter_modules/azure_sentinel/stix_translation/results_translator.py
--rw-rw-r--  2.0 unx     7822 b- defN 23-Mar-21 13:47 stix_shifter_modules/azure_sentinel/stix_translation/json/from_stix_map.json
--rw-rw-r--  2.0 unx      510 b- defN 23-Mar-21 13:47 stix_shifter_modules/azure_sentinel/stix_translation/json/operators.json
--rw-rw-r--  2.0 unx    16095 b- defN 23-Mar-21 13:47 stix_shifter_modules/azure_sentinel/stix_translation/json/to_stix_map.json
--rw-rw-r--  2.0 unx     7188 b- defN 23-Mar-21 13:47 stix_shifter_modules/azure_sentinel/stix_translation/json/stix_2_1/from_stix_map.json
--rw-rw-r--  2.0 unx    15948 b- defN 23-Mar-21 13:47 stix_shifter_modules/azure_sentinel/stix_translation/json/stix_2_1/to_stix_map.json
--rw-rw-r--  2.0 unx        0 b- defN 23-Mar-21 13:47 stix_shifter_modules/azure_sentinel/stix_transmission/__init__.py
--rw-rw-r--  2.0 unx     2473 b- defN 23-Mar-21 13:47 stix_shifter_modules/azure_sentinel/stix_transmission/api_client.py
--rw-rw-r--  2.0 unx     6873 b- defN 23-Mar-21 13:47 stix_shifter_modules/azure_sentinel/stix_transmission/connector.py
--rw-rw-r--  2.0 unx     2852 b- defN 23-Mar-21 13:47 stix_shifter_modules/azure_sentinel/stix_transmission/error_mapper.py
--rw-rw-r--  2.0 unx    12786 b- defN 23-Mar-21 13:51 stix_shifter_modules_azure_sentinel-5.1.1.dist-info/LICENSE.md
--rw-rw-r--  2.0 unx     7278 b- defN 23-Mar-21 13:51 stix_shifter_modules_azure_sentinel-5.1.1.dist-info/METADATA
--rw-rw-r--  2.0 unx     1418 b- defN 23-Mar-21 13:51 stix_shifter_modules_azure_sentinel-5.1.1.dist-info/NOTICE
--rw-rw-r--  2.0 unx      110 b- defN 23-Mar-21 13:51 stix_shifter_modules_azure_sentinel-5.1.1.dist-info/WHEEL
--rw-rw-r--  2.0 unx       21 b- defN 23-Mar-21 13:51 stix_shifter_modules_azure_sentinel-5.1.1.dist-info/top_level.txt
-?rw-rw-r--  2.0 unx     3022 b- defN 23-Mar-21 13:51 stix_shifter_modules_azure_sentinel-5.1.1.dist-info/RECORD
-25 files, 188119 bytes uncompressed, 36023 bytes compressed:  80.9%
+Zip file size: 41452 bytes, number of entries: 25
+-rw-rw-r--  2.0 unx        0 b- defN 23-Apr-24 17:21 stix_shifter_modules/azure_sentinel/__init__.py
+-rw-rw-r--  2.0 unx      432 b- defN 23-Apr-24 17:21 stix_shifter_modules/azure_sentinel/entry_point.py
+-rw-rw-r--  2.0 unx    55649 b- defN 23-Apr-24 17:23 stix_shifter_modules/azure_sentinel/configuration/config.json
+-rw-rw-r--  2.0 unx       78 b- defN 23-Apr-24 17:23 stix_shifter_modules/azure_sentinel/configuration/dialects.json
+-rw-rw-r--  2.0 unx     3405 b- defN 23-Apr-24 17:23 stix_shifter_modules/azure_sentinel/configuration/lang_en.json
+-rw-rw-r--  2.0 unx        0 b- defN 23-Apr-24 17:21 stix_shifter_modules/azure_sentinel/stix_translation/__init__.py
+-rw-rw-r--  2.0 unx    21897 b- defN 23-Apr-24 17:23 stix_shifter_modules/azure_sentinel/stix_translation/json_to_stix_translator.py
+-rw-rw-r--  2.0 unx    22280 b- defN 23-Apr-24 17:21 stix_shifter_modules/azure_sentinel/stix_translation/query_constructor.py
+-rw-rw-r--  2.0 unx     1037 b- defN 23-Apr-24 17:21 stix_shifter_modules/azure_sentinel/stix_translation/query_translator.py
+-rw-rw-r--  2.0 unx      133 b- defN 23-Apr-24 17:21 stix_shifter_modules/azure_sentinel/stix_translation/results_translator.py
+-rw-rw-r--  2.0 unx     7822 b- defN 23-Apr-24 17:21 stix_shifter_modules/azure_sentinel/stix_translation/json/from_stix_map.json
+-rw-rw-r--  2.0 unx      510 b- defN 23-Apr-24 17:21 stix_shifter_modules/azure_sentinel/stix_translation/json/operators.json
+-rw-rw-r--  2.0 unx    16095 b- defN 23-Apr-24 17:21 stix_shifter_modules/azure_sentinel/stix_translation/json/to_stix_map.json
+-rw-rw-r--  2.0 unx     7188 b- defN 23-Apr-24 17:21 stix_shifter_modules/azure_sentinel/stix_translation/json/stix_2_1/from_stix_map.json
+-rw-rw-r--  2.0 unx    15948 b- defN 23-Apr-24 17:21 stix_shifter_modules/azure_sentinel/stix_translation/json/stix_2_1/to_stix_map.json
+-rw-rw-r--  2.0 unx        0 b- defN 23-Apr-24 17:21 stix_shifter_modules/azure_sentinel/stix_transmission/__init__.py
+-rw-rw-r--  2.0 unx     3292 b- defN 23-Apr-24 17:21 stix_shifter_modules/azure_sentinel/stix_transmission/api_client.py
+-rw-rw-r--  2.0 unx     6341 b- defN 23-Apr-24 17:21 stix_shifter_modules/azure_sentinel/stix_transmission/connector.py
+-rw-rw-r--  2.0 unx     2942 b- defN 23-Apr-24 17:21 stix_shifter_modules/azure_sentinel/stix_transmission/error_mapper.py
+-rw-rw-r--  2.0 unx    12786 b- defN 23-Apr-24 17:23 stix_shifter_modules_azure_sentinel-5.1.1.dev796.dist-info/LICENSE.md
+-rw-rw-r--  2.0 unx     7285 b- defN 23-Apr-24 17:23 stix_shifter_modules_azure_sentinel-5.1.1.dev796.dist-info/METADATA
+-rw-rw-r--  2.0 unx     1418 b- defN 23-Apr-24 17:23 stix_shifter_modules_azure_sentinel-5.1.1.dev796.dist-info/NOTICE
+-rw-rw-r--  2.0 unx      110 b- defN 23-Apr-24 17:23 stix_shifter_modules_azure_sentinel-5.1.1.dev796.dist-info/WHEEL
+-rw-rw-r--  2.0 unx       21 b- defN 23-Apr-24 17:23 stix_shifter_modules_azure_sentinel-5.1.1.dev796.dist-info/top_level.txt
+?rw-rw-r--  2.0 unx     3064 b- defN 23-Apr-24 17:23 stix_shifter_modules_azure_sentinel-5.1.1.dev796.dist-info/RECORD
+25 files, 189733 bytes uncompressed, 36122 bytes compressed:  81.0%
```

## zipnote {}

```diff
@@ -51,26 +51,26 @@
 
 Filename: stix_shifter_modules/azure_sentinel/stix_transmission/connector.py
 Comment: 
 
 Filename: stix_shifter_modules/azure_sentinel/stix_transmission/error_mapper.py
 Comment: 
 
-Filename: stix_shifter_modules_azure_sentinel-5.1.1.dist-info/LICENSE.md
+Filename: stix_shifter_modules_azure_sentinel-5.1.1.dev796.dist-info/LICENSE.md
 Comment: 
 
-Filename: stix_shifter_modules_azure_sentinel-5.1.1.dist-info/METADATA
+Filename: stix_shifter_modules_azure_sentinel-5.1.1.dev796.dist-info/METADATA
 Comment: 
 
-Filename: stix_shifter_modules_azure_sentinel-5.1.1.dist-info/NOTICE
+Filename: stix_shifter_modules_azure_sentinel-5.1.1.dev796.dist-info/NOTICE
 Comment: 
 
-Filename: stix_shifter_modules_azure_sentinel-5.1.1.dist-info/WHEEL
+Filename: stix_shifter_modules_azure_sentinel-5.1.1.dev796.dist-info/WHEEL
 Comment: 
 
-Filename: stix_shifter_modules_azure_sentinel-5.1.1.dist-info/top_level.txt
+Filename: stix_shifter_modules_azure_sentinel-5.1.1.dev796.dist-info/top_level.txt
 Comment: 
 
-Filename: stix_shifter_modules_azure_sentinel-5.1.1.dist-info/RECORD
+Filename: stix_shifter_modules_azure_sentinel-5.1.1.dev796.dist-info/RECORD
 Comment: 
 
 Zip file comment:
```

## stix_shifter_modules/azure_sentinel/configuration/config.json

### Pretty-printed

 * *Similarity: 0.9613095238095238%*

 * *Differences: {"'connection'": "{'type': {'group': 'microsoft'}, delete: ['host']}"}*

```diff
@@ -19,19 +19,14 @@
         }
     },
     "connection": {
         "help": {
             "default": "data-sources-sentinel.html",
             "type": "link"
         },
-        "host": {
-            "default": "graph.microsoft.com",
-            "regex": "^(([a-zA-Z0-9]|[a-zA-Z0-9][a-zA-Z0-9_:/\\-]*[a-zA-Z0-9])\\.)*([A-Za-z0-9]|[A-Za-z0-9][A-Za-z0-9_:/\\-]*[A-Za-z0-9])$",
-            "type": "text"
-        },
         "options": {
             "async_call": {
                 "hidden": true,
                 "optional": true,
                 "type": "text"
             },
             "dialects": {
@@ -1181,12 +1176,12 @@
         },
         "sni": {
             "optional": true,
             "type": "text"
         },
         "type": {
             "displayName": "Microsoft Graph Security",
-            "group": "azure",
+            "group": "microsoft",
             "type": "connectorType"
         }
     }
 }
```

## stix_shifter_modules/azure_sentinel/configuration/lang_en.json

### Pretty-printed

 * *Similarity: 0.9787016369047619%*

 * *Differences: {"'configuration'": "{'auth': {'clientId': {'label': 'Client ID'}, 'clientSecret': {'label': "*

 * *                    "'Client secret'}}}",*

 * * "'connection'": "{'port': {'label': 'Host port'}, 'selfSignedCert': {'label': 'Microsoft Azure "*

 * *                 "Sentinel certificate'}, 'options': {'result_limit': {'label': 'Result size "*

 * *                 "limit'}, 'time_range': {'label': 'Query time range'}, 'timeout': {'label': "*

 * *                 "'Query response timeout limit'}, 'validate_pattern': {'label': 'STIX  [â€¦]*

```diff
@@ -1,17 +1,17 @@
 {
     "configuration": {
         "auth": {
             "clientId": {
                 "description": "Client ID of Azure Active directory Application with access to the Microsoft Graph API",
-                "label": "Client Id"
+                "label": "Client ID"
             },
             "clientSecret": {
                 "description": "Client Secret of Azure Active directory Application with access to the Microsoft Graph API",
-                "label": "Client Secret"
+                "label": "Client secret"
             },
             "tenant": {
                 "description": "Tenant ID of Azure Active directory Application with access to the Microsoft Graph API",
                 "label": "Tenant"
             }
         }
     },
@@ -23,52 +23,52 @@
         "host": {
             "description": "Specify the IP address or hostname of the data source",
             "label": "Management IP address or hostname"
         },
         "options": {
             "concurrent": {
                 "description": "The number of simultaneous connections that can be made to the data source.  Valid input range is {{min}} to {{max}}.",
-                "label": "Concurrent Search Limit"
+                "label": "Concurrent search limit"
             },
             "dialects": {
                 "description": "The dialect to use if the data source needs to search multiple schema or database tables.",
                 "label": "Dialect"
             },
             "mapping": {
                 "description": "Custom stix mapping if default mapping needs to be replaced",
-                "label": "Custom Mapping"
+                "label": "Custom mapping"
             },
             "result_limit": {
                 "description": "The maximum number of entries or objects that are returned by search query.  Valid input range is {{min}} to {{max}}.",
-                "label": "Result Size Limit"
+                "label": "Result size limit"
             },
             "stix_validator": {
                 "description": "Validate translated STIX Objects",
-                "label": "STIX Object Validator"
+                "label": "STIX object validator"
             },
             "time_range": {
                 "description": "Time range for the search, in minutes, represented as last x minutes.  Valid input range is {{min}} to {{max}}.",
-                "label": "Query Time Range"
+                "label": "Query time range"
             },
             "timeout": {
                 "description": "The limit on how long to wait for the data source response, in seconds. Valid input range is {{min}} to {{max}}.",
-                "label": "Query Response Timeout Limit"
+                "label": "Query response timeout limit"
             },
             "validate_pattern": {
                 "description": "Validate STIX patterns that needs to be translated into native data source query",
-                "label": "STIX Pattern Validator"
+                "label": "STIX pattern validator"
             }
         },
         "port": {
             "description": "Set the port number that is associated with the hostname or IP address",
-            "label": "Host Port"
+            "label": "Host port"
         },
         "selfSignedCert": {
             "description": "Use SSL certificate for Microsoft Azure Sentinel.",
-            "label": "Microsoft Azure Sentinel Certificate"
+            "label": "Microsoft Azure Sentinel certificate"
         },
         "sni": {
             "description": "The Server Name Indicator (SNI) enables a separate hostname to be provided for SSL authentication.",
             "label": "Server Name Indicator"
         },
         "type": {
             "description": "Data source type"
```

## stix_shifter_modules/azure_sentinel/stix_translation/json_to_stix_translator.py

```diff
@@ -15,41 +15,49 @@
 NUMBER_OBSERVED_KEY = 'number_observed'
 FIRST_OBSERVED_KEY = 'first_observed'
 LAST_OBSERVED_KEY = 'last_observed'
 
 
 # convert JSON data to STIX object using map_data and transformers
 def convert_to_stix(data_source, map_data, data, transformers, options, callback=None):
+    try:
+        ds2stix = DataSourceObjToStixObj(data_source, map_data, transformers, options, callback)
 
-    ds2stix = DataSourceObjToStixObj(data_source, map_data, transformers, options, callback)
-
-    # map data list to list of transformed objects
-    observation = ds2stix.transform
-    results = list(map(observation, data))
-
-    for stix_object in results:
-        if ds2stix.spec_version == "2.1":
-            del stix_object["objects"]
-        ds2stix.bundle["objects"].append(stix_object)
-
-    for _, value in ds2stix.unique_cybox_objects.items():
-        ds2stix.bundle["objects"].append(value)
-
-    if options.get('stix_validator'):
-        if ds2stix.spec_version == "2.1":
-            # Serialize and Deserialize bundle to covert StixObjectIds to strings
-            bundle_obj = json.dumps(ds2stix.bundle, sort_keys=False)
-            bundle_obj = json.loads(bundle_obj)
-        else:
-            bundle_obj = ds2stix.bundle
-        validated_result = validate_instance(bundle_obj, ValidationOptions(version=ds2stix.spec_version))
-        print_results(validated_result)
-
-    return ds2stix.bundle
-
+        # map data list to list of transformed objects
+        observation = ds2stix.transform
+        results = list(map(observation, data))
+
+        for stix_object in results:
+            if ds2stix.spec_version == "2.1":
+                del stix_object["objects"]
+            ds2stix.bundle["objects"].append(stix_object)
+
+        for _, value in ds2stix.unique_cybox_objects.items():
+            ds2stix.bundle["objects"].append(value)
+
+        if options.get('stix_validator'):
+            if ds2stix.spec_version == "2.1":
+                # Serialize and Deserialize bundle to covert StixObjectIds to strings
+                bundle_obj = json.dumps(ds2stix.bundle, sort_keys=False)
+                bundle_obj = json.loads(bundle_obj)
+            else:
+                bundle_obj = ds2stix.bundle
+            validated_result = validate_instance(bundle_obj, ValidationOptions(version=ds2stix.spec_version))
+            print_results(validated_result)
+
+        return ds2stix.bundle
+
+    except Exception as e:
+        try:
+            # try to print the error line
+            logger_log = logger.set_logger(__name__)
+            logger_log.error(logger.last_tb_to_string(e))
+        except:
+            pass
+        raise e
 
 class DataSourceObjToStixObj:
     logger = logger.set_logger(__name__)
 
     def __init__(self, data_source, ds_to_stix_map, transformers, options, callback=None):
         self.identity_id = data_source["id"]
         self.ds_to_stix_map = ds_to_stix_map
```

## stix_shifter_modules/azure_sentinel/stix_translation/query_constructor.py

```diff
@@ -2,15 +2,21 @@
     ComparisonExpressionOperators, ComparisonComparators, Pattern, \
     CombinedComparisonExpression, CombinedObservationExpression
 from stix_shifter_utils.stix_translation.src.patterns.errors import SearchFeatureNotSupportedError
 from datetime import datetime, timedelta
 import re
 
 START_STOP_PATTERN = r"(\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(\.\d+)?Z)"
-
+# List of Alert properties of type collection without nested properties
+ALERT_COLLECTION = ['comments',
+                    'detectionIds',
+                    'incidentIds',
+                    'recommendedActions',
+                    'sourceMaterials',
+                    'tags']
 
 class QueryStringPatternTranslator:
     COUNTER = 0
 
     # comparator lookup for implementing negation operator
     negated_comparator_lookup = {
         ComparisonComparators.GreaterThan: "le",
@@ -189,14 +195,25 @@
                                     attribute_expression=attribute_expression,
                                     comparator=comparator, value=value)
                     else:
                         comparison_string += "{collection_name}/any({fn}:{attribute_expression} {comparator} {value})" \
                             .format(collection_name=collection_name, fn=lambda_func,
                                     attribute_expression=attribute_expression,
                                     comparator=comparator, value=value)
+            # this condition construct query string for string collection that doesn't contain any nested properties
+            elif mapped_field in ALERT_COLLECTION:
+                if comparator == 'ne':
+                    # To negate the result of the expression use the not operator, not the ne operator.
+                    comparison_string += "NOT({collection_name}/any({fn}:{fn} eq {value}))".format(
+                            collection_name=mapped_field, fn=lambda_func, comparator=comparator,
+                            value=value)
+                else:
+                    comparison_string += "{collection_name}/any({fn}:{fn} {comparator} {value})".format(
+                            collection_name=mapped_field, fn=lambda_func, comparator=comparator,
+                            value=value)
             else:
                 # check for mapped field that does not have '.' character -> example [azureTenantId,title]
                 if comparator == 'contains':
                     comparison_string += "{comparator}(tolower({mapped_field}), {value})".format(
                         mapped_field=mapped_field, comparator=comparator, value=value)
                 else:
                     comparison_string += "tolower({mapped_field}) {comparator} {value}".format(
```

## stix_shifter_modules/azure_sentinel/stix_transmission/api_client.py

```diff
@@ -1,58 +1,71 @@
+from azure.identity.aio import ClientSecretCredential
 from stix_shifter_utils.stix_transmission.utils.RestApiClientAsync import RestApiClientAsync
 
 
 class APIClient:
     """API Client to handle all calls."""
+    credential = None
     
-    def __init__(self, connection, configuration):
+    def __init__(self, base_uri, connection, configuration):
         """Initialization.
         :param connection: dict, connection dict
         :param configuration: dict,config dict"""
-
-        headers = dict()
-        url_modifier_function = None
         default_api_version = 'v1.0'
-        auth = configuration.get('auth')
+        self.host = base_uri
         self.endpoint = '{api_version}/security/alerts'.format(api_version=default_api_version)
-        self.host = connection.get('host')
+        self.connection = connection
+        self.configuration = configuration
         self.timeout = connection['options'].get('timeout')
+    
+    async def init_async_client(self):
+        headers = dict()
 
-        if auth:
-            if 'access_token' in auth:
-                headers['Authorization'] = "Bearer " + auth['access_token']
+        if 'access_token' in self.configuration.get("auth"):
+            self.access_token = self.configuration["auth"]['access_token']
+            headers['Authorization'] = "Bearer " + self.access_token
+        else:
+            self.credential = ClientSecretCredential(tenant_id=self.configuration["auth"]["tenant"],
+                                                    client_id=self.configuration["auth"]["clientId"],
+                                                    client_secret=self.configuration["auth"]["clientSecret"])
+            async with self.credential:
+                self.access_token = await self.credential.get_token("https://{host}/.default".format(host=self.host))
+                headers['Authorization'] = "Bearer " + self.access_token.token
 
-        self.client = RestApiClientAsync(connection.get('host'),
-                                    connection.get('port', None),
+        self.client = RestApiClientAsync(self.host,
+                                    self.connection.get('port', None),
                                     headers,
-                                    url_modifier_function=url_modifier_function,
-                                    cert_verify=connection.get('selfSignedCert', True),
-                                    sni=connection.get('sni', None)
+                                    cert_verify=self.connection.get('selfSignedCert', True),
+                                    sni=self.connection.get('sni', None)
                                     )
+        return self.client
 
     async def ping_box(self):
         """Ping the endpoint."""
         params = dict()
         params['$top'] = 1
+        await self.init_async_client()
         return await self.client.call_api(self.endpoint, 'GET', urldata=params, timeout=self.timeout)
 
     async def run_search(self, query_expression, length):
         """get the response from azure_sentinel endpoints
         :param query_expression: str, search_id
         :param length: int,length value
         :return: response, json object"""
         headers = dict()
         headers['Accept'] = 'application/json'
         params = dict()
         params['$filter'] = query_expression
         params['$top'] = length
+        await self.init_async_client()
         return await self.client.call_api(self.endpoint, 'GET', headers, urldata=params, timeout=self.timeout)
 
     async def next_page_run_search(self, next_page_url):
         """get the response from azure_sentinel endpoints
         :param next_page_url: str, search_id
         :return: response, json object"""
         headers = dict()
         headers['Accept'] = 'application/json'
         url = next_page_url.split('?', maxsplit=1)[1]
         endpoint = self.endpoint + '?' + url
+        await self.init_async_client()
         return await self.client.call_api(endpoint, 'GET', headers, timeout=self.timeout)
```

## stix_shifter_modules/azure_sentinel/stix_transmission/connector.py

```diff
@@ -1,48 +1,54 @@
 import json
-import adal
-import re
-from flatten_json import flatten
+from azure.core.exceptions import ClientAuthenticationError
 from stix_shifter_utils.modules.base.stix_transmission.base_json_sync_connector import BaseJsonSyncConnector
 from .api_client import APIClient
 from stix_shifter_utils.utils.error_response import ErrorResponder
 from stix_shifter_utils.utils import logger
 
 
 class Connector(BaseJsonSyncConnector):
-    init_error = None
+    api_client = None
     max_limit = 1000
+    base_uri = 'graph.microsoft.com' # Microsoft Graph API has single endpoint
 
     def __init__(self, connection, configuration):
         """Initialization.
         :param connection: dict, connection dict
         :param configuration: dict,config dict"""
         self.logger = logger.set_logger(__name__)
         self.connector = __name__.split('.')[1]
-        self.adal_response = Connector.generate_token(self, connection, configuration)
-        if self.adal_response['success']:
-            configuration['auth']['access_token'] = self.adal_response['access_token']
-            self.api_client = APIClient(connection, configuration)
-        else:
-            self.init_error = True
-
+        self.connection = connection
+        self.configuration = configuration
+        self.api_client = APIClient(self.base_uri, self.connection, self.configuration)
 
     async def ping_connection(self):
         """Ping the endpoint."""
         return_obj = dict()
-        if self.init_error:
-            self.logger.error("Token Generation Failed:")
-            return self.adal_response
-        response = await self.api_client.ping_box()
-        response_code = response.code
-        response_dict = json.loads(response.read())
-        if 200 <= response_code < 300:
-            return_obj['success'] = True
-        else:
+        response_dict = dict()
+        try:
+            response = await self.api_client.ping_box()
+            response_code = response.code
+            response_dict = json.loads(response.read())
+            if 200 <= response_code < 300:
+                return_obj['success'] = True
+            else:
+                ErrorResponder.fill_error(return_obj, response_dict, ['error', 'message'], connector=self.connector)
+        except ClientAuthenticationError as ex:
+            response_dict['code'] = 'unauthorized_client'
+            response_dict['message'] = str(ex)
+            ErrorResponder.fill_error(return_obj, response_dict, ['error', 'message'], connector=self.connector)
+        except Exception as ex:
+            if "server timeout_error" in str(ex) or "timeout_error" in str(ex):
+                response_dict['code'] = 'HTTPSConnectionError'
+            else:
+                response_dict['code'] = 'invalid_client'
+            response_dict['error'] = str(ex)
             ErrorResponder.fill_error(return_obj, response_dict, ['error', 'message'], connector=self.connector)
+
         return return_obj
 
     async def delete_query_connection(self, search_id):
         """"delete_query_connection response
         :param search_id: str, search_id"""
         return {"success": True, "search_id": search_id}
 
@@ -57,17 +63,14 @@
         length = int(length)
         offset = int(offset)
 
         # total records is the sum of the offset and length(limit) value
         total_records = offset + length
 
         try:
-            if self.init_error:
-                self.logger.error("Token Generation Failed:")
-                return self.adal_response
             # check for length value against the max limit(1000) of $top param in data source
             if length <= self.max_limit:
                 # $skip(offset) param not included as data source provides incorrect results for some of the queries
                 response = await self.api_client.run_search(query, total_records)
             elif length > self.max_limit:
                 response = await self.api_client.run_search(query, self.max_limit)
             response_code = response.code
@@ -111,46 +114,21 @@
                     update_node.append(node)
 
                 return_obj['data'] = update_node
 
             else:
                 ErrorResponder.fill_error(return_obj, response_dict, ['error', 'message'], connector=self.connector)
 
+        except ClientAuthenticationError as ex:
+            response_dict['code'] = 'unauthorized_client'
+            response_dict['message'] = str(ex)
+            ErrorResponder.fill_error(return_obj, response_dict, ['error', 'message'], connector=self.connector)
         except Exception as ex:
-            if response_dict is not None:
-                ErrorResponder.fill_error(return_obj, message='unexpected exception', connector=self.connector)
-                self.logger.error('can not parse response: ' + str(response_dict))
+            if "server timeout_error" in str(ex) or "timeout_error" in str(ex):
+                response_dict['code'] = 'HTTPSConnectionError'
             else:
-                raise ex
+                response_dict['code'] = 'invalid_client'
+            response_dict['error'] = str(ex)
+            ErrorResponder.fill_error(return_obj, response_dict, ['error', 'message'], connector=self.connector)
         return return_obj
 
-    @staticmethod
-    def generate_token(self, connection, configuration):
-        """To generate the Token
-        :param connection: dict, connection dict
-        :param configuration: dict,config dict"""
-        return_obj = dict()
-
-        authority_url = ('https://login.microsoftonline.com/' +
-                         configuration['auth']['tenant'])
-        resource = "https://" + str(connection.get('host'))
-
-        try:
-            context = adal.AuthenticationContext(
-                authority_url, validate_authority=configuration['auth']['tenant'] != 'adfs',
-            )
-            response_dict = context.acquire_token_with_client_credentials(
-                resource,
-                configuration['auth']['clientId'],
-                configuration['auth']['clientSecret'])
-
-            return_obj['success'] = True
-            return_obj['access_token'] = response_dict['accessToken']
-
-        except Exception as ex:
-            if ex.__class__.__name__ == 'AdalError':
-                response_dict = ex.error_response
-                ErrorResponder.fill_error(return_obj, response_dict, ['error_description'],  connector=self.connector)
-            else:
-                ErrorResponder.fill_error(return_obj, message=str(ex), connector=self.connector)
-
-        return return_obj
+
```

## stix_shifter_modules/azure_sentinel/stix_transmission/error_mapper.py

```diff
@@ -42,19 +42,21 @@
         """ms_atp transmit specified error
          :param json_data: dict, error response of api_call
          :param return_obj: dict, returns error and error code"""
         error_type = ''
         
         if isinstance(json_data, tuple):
             error_type = 'HTTPSConnectionError'
+        elif 'code' in json_data.get('error', {}):
+            error_type = json_data['error']['code']
+        elif json_data.get('error'):
+            error_type = json_data['error']
         else:
-            try:
-                error_type = json_data['error']['code']
-            except Exception:
-                error_type = json_data['error']
+            error_type = 'notSupported'
+                
 
         error_code = ErrorMapper.DEFAULT_ERROR
 
         if error_type in ERROR_MAPPING:
             error_code = ERROR_MAPPING[error_type]
 
         if error_code == ErrorMapper.DEFAULT_ERROR:
```

## Comparing `stix_shifter_modules_azure_sentinel-5.1.1.dist-info/LICENSE.md` & `stix_shifter_modules_azure_sentinel-5.1.1.dev796.dist-info/LICENSE.md`

 * *Files identical despite different names*

## Comparing `stix_shifter_modules_azure_sentinel-5.1.1.dist-info/METADATA` & `stix_shifter_modules_azure_sentinel-5.1.1.dev796.dist-info/METADATA`

 * *Files 1% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: stix-shifter-modules-azure-sentinel
-Version: 5.1.1
+Version: 5.1.1.dev796
 Summary: Tools and interface to translate STIX formatted results and queries to different data source formats and to set up appropriate connection strings for invoking and triggering actions in openwhisk
 Home-page: https://github.com/opencybersecurityalliance/stix-shifter
 Author: ibm
 Author-email: 
 Project-URL: Source, https://github.com/opencybersecurityalliance/stix-shifter
 Keywords: datasource stix translate transform transmit
 Classifier: License :: OSI Approved :: Apache Software License
```

## Comparing `stix_shifter_modules_azure_sentinel-5.1.1.dist-info/NOTICE` & `stix_shifter_modules_azure_sentinel-5.1.1.dev796.dist-info/NOTICE`

 * *Files identical despite different names*

## Comparing `stix_shifter_modules_azure_sentinel-5.1.1.dist-info/RECORD` & `stix_shifter_modules_azure_sentinel-5.1.1.dev796.dist-info/RECORD`

 * *Files 11% similar despite different names*

```diff
@@ -1,25 +1,25 @@
 stix_shifter_modules/azure_sentinel/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 stix_shifter_modules/azure_sentinel/entry_point.py,sha256=0_DgaxSwIV5Frbe51iwGRkjkCF56EoE7i8IfdkYfm8w,432
-stix_shifter_modules/azure_sentinel/configuration/config.json,sha256=9I36XPiyNhfIRsJLuao3SIIogeEIqrb-WzTOs8mL21U,55888
+stix_shifter_modules/azure_sentinel/configuration/config.json,sha256=91Vt_Xf5ERcNnqj5jowplP_Fzy1csMO8JKGaDLSJrKc,55649
 stix_shifter_modules/azure_sentinel/configuration/dialects.json,sha256=tewYuoIE-WBBxsLTlOstMkMSUs6sFlEyW1dveC61xwk,78
-stix_shifter_modules/azure_sentinel/configuration/lang_en.json,sha256=4y89oLD3kjMf2cV2AA6ATHSVJIbuy_g_nG-KoT4FTNI,3405
+stix_shifter_modules/azure_sentinel/configuration/lang_en.json,sha256=elbO58OZU4zy0YRlDTVhwbRPb-JEujKVVFY4oO8PZ-c,3405
 stix_shifter_modules/azure_sentinel/stix_translation/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
-stix_shifter_modules/azure_sentinel/stix_translation/json_to_stix_translator.py,sha256=72KkjPPwPGUxxyhtYaq9CcFAOOKG_emxSqKeCnmveyw,21567
-stix_shifter_modules/azure_sentinel/stix_translation/query_constructor.py,sha256=eFpQix65h4PdCDbJuds7X9BzNfARQsp0vXYJ2pYuNM8,21183
+stix_shifter_modules/azure_sentinel/stix_translation/json_to_stix_translator.py,sha256=Y1Vxu4Ry0YG1E0fGPjaXGYjMkzXlcs7hZJicAGMGfh4,21897
+stix_shifter_modules/azure_sentinel/stix_translation/query_constructor.py,sha256=sv0-0pj_aUg03_mnkmRxz8BbqNuTiF9gKc89rAA0Zv4,22280
 stix_shifter_modules/azure_sentinel/stix_translation/query_translator.py,sha256=3YEkKNfWzvpt16rkPzfAtKQjzo039Gyo-Ff9s95vnsA,1037
 stix_shifter_modules/azure_sentinel/stix_translation/results_translator.py,sha256=DG5PcExUGumeGNNhjWAdFq2YJK24T0vg8WKM5MQ5H1k,133
 stix_shifter_modules/azure_sentinel/stix_translation/json/from_stix_map.json,sha256=9ympxibe1hzzg__IcUucD9V4ojFhhtM0XfVeRWu3g7E,7822
 stix_shifter_modules/azure_sentinel/stix_translation/json/operators.json,sha256=42CI1zuE9V1LWLhe09TRmyk3aqscoyA0bOZruiuW8yQ,510
 stix_shifter_modules/azure_sentinel/stix_translation/json/to_stix_map.json,sha256=x1JS-sw8W1ERSyChtqKPoVNDet4XJiQzHRKTTqjKOwE,16095
 stix_shifter_modules/azure_sentinel/stix_translation/json/stix_2_1/from_stix_map.json,sha256=cpuAOrxj9lPeU_l8KDrX98JmbqpypcT6I_1T45Nk9c4,7188
 stix_shifter_modules/azure_sentinel/stix_translation/json/stix_2_1/to_stix_map.json,sha256=g-h9cr3lIoBkDYxVgxO4cGP7LhfTbYMUDwTvr1_w_kk,15948
 stix_shifter_modules/azure_sentinel/stix_transmission/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
-stix_shifter_modules/azure_sentinel/stix_transmission/api_client.py,sha256=ERM42_3oHadRE385aUD03fIeRqaqkvdVDdRtVS8wVTI,2473
-stix_shifter_modules/azure_sentinel/stix_transmission/connector.py,sha256=CqlSMIz3jLnyeuVQZ755OppLSiHMP6ZjAbRg-zZVGn4,6873
-stix_shifter_modules/azure_sentinel/stix_transmission/error_mapper.py,sha256=TYWMy5MfSN47OqBPmlRlBdUcM_N91F_4LsWegSazUHM,2852
-stix_shifter_modules_azure_sentinel-5.1.1.dist-info/LICENSE.md,sha256=ssGEKMVW69oFTBblVhD1YPolqCOyOCJi4wRDRI7xCnU,12786
-stix_shifter_modules_azure_sentinel-5.1.1.dist-info/METADATA,sha256=nFNybB-mHrGmnaNO1p902Oxsv0uUtzabjNI0LmUFdM0,7278
-stix_shifter_modules_azure_sentinel-5.1.1.dist-info/NOTICE,sha256=wx-gWE9vSnLJ7YQkrGlMp9VNXOXG57TTxDDRd9CEdYg,1418
-stix_shifter_modules_azure_sentinel-5.1.1.dist-info/WHEEL,sha256=bb2Ot9scclHKMOLDEHY6B2sicWOgugjFKaJsT7vwMQo,110
-stix_shifter_modules_azure_sentinel-5.1.1.dist-info/top_level.txt,sha256=NX-VgUOr8fI-lMXHt3gtjfsEn1UPaGAVszt6Z_CTp2s,21
-stix_shifter_modules_azure_sentinel-5.1.1.dist-info/RECORD,,
+stix_shifter_modules/azure_sentinel/stix_transmission/api_client.py,sha256=XfDSWMDA0dR4tyjG_msau2iGMG8vL2MMQEQXYCfiHNU,3292
+stix_shifter_modules/azure_sentinel/stix_transmission/connector.py,sha256=dM013tyJUisHcXwA3fYNAVta7-6_6rbC5puin8_zSw8,6341
+stix_shifter_modules/azure_sentinel/stix_transmission/error_mapper.py,sha256=9WSidNtuzCJBkxWV7VrQbtBpVdjl56qyB3jQ8DWUb7c,2942
+stix_shifter_modules_azure_sentinel-5.1.1.dev796.dist-info/LICENSE.md,sha256=ssGEKMVW69oFTBblVhD1YPolqCOyOCJi4wRDRI7xCnU,12786
+stix_shifter_modules_azure_sentinel-5.1.1.dev796.dist-info/METADATA,sha256=VIYDTFQ5F65Groqe3tXoPA4PmWPuBtniqDNGQ1igAsY,7285
+stix_shifter_modules_azure_sentinel-5.1.1.dev796.dist-info/NOTICE,sha256=wx-gWE9vSnLJ7YQkrGlMp9VNXOXG57TTxDDRd9CEdYg,1418
+stix_shifter_modules_azure_sentinel-5.1.1.dev796.dist-info/WHEEL,sha256=bb2Ot9scclHKMOLDEHY6B2sicWOgugjFKaJsT7vwMQo,110
+stix_shifter_modules_azure_sentinel-5.1.1.dev796.dist-info/top_level.txt,sha256=NX-VgUOr8fI-lMXHt3gtjfsEn1UPaGAVszt6Z_CTp2s,21
+stix_shifter_modules_azure_sentinel-5.1.1.dev796.dist-info/RECORD,,
```

